@REV_TRAIN_GAIRAI
#DIM 候補, 1000
#DIM 候補数
#DIM 参加者, 8
#DIM 参加者数
#DIM 外来
#DIM ループ数
VARSET 候補, -1
VARSET 候補数
VARSET 参加者, -1
VARSET 参加者数

外来 = GET_COUNTRY_FROM_ID(COUNTRY_GAIRAI)
;ゴブリンによる主人公以外のキャラへの自動調教
IF FLAG:28
	CALL TRAIN_BY_GAIRAI
ENDIF

IF !FLAG:14
	FLAG:14 = 1
	IF !VAGINA(MASTER) && GAIRAI_SEX_VS(MASTER) != 1
		DRAWLINE
		PRINTFORMW 外来人は%ANAME(MASTER)%に、男娼にされたいか、女にされて犯されたいか聞いてきた
		CALL ASK_YN("女にされるなんて御免だ！(男娼化)", "いっそ女にされた方がマシだ…(女性化)")
		IF RESULT == 0
			PRINTFORMW 外来人は%ANAME(MASTER)%の返事を聞くと、%ANAME(MASTER)%を取り押さえ裸に剥き、縄で拘束した
			PRINTFORMW どうやら男であろうと本気で犯すつもりのようだ…
		ELSE
			PRINTFORMW 外来人は%ANAME(MASTER)%の返事を聞くと、%ANAME(MASTER)%の口に何かを押し込んで無理やり飲ませた
			PRINTFORMW すると突然意識が遠くなっていく…
			PRINTFORMW ………………
			PRINTFORMW ……
			PRINTFORMW しばらくして目を覚ますと、%ANAME(MASTER)%は体に違和感を覚えた
			PRINTFORMW 股間にはあるべきものがなく、胸にも重みを感じる
			PRINTFORMW どうやら本当に女性の体になってしまったようだ
			PRINTFORMW 周りを取り囲む外来人たちの視線が肌に突き刺さり、思わず%ANAME(MASTER)%は身震いした…
			IF TALENT:MASTER:性別 == 4
				;元男の娘フラグ
				CFLAG:MASTER:66 = 1
			ENDIF
			TALENT:MASTER:性別 = 1
		ENDIF
	ENDIF
ENDIF


;四回ごとに誘われる
IF FLAG:47 > 0 && FLAG:47 % 4 == 0
	PRINTFORML 調教の時間が近づくと、%ANAME(MASTER)%はいつものように「研究室」で拘束され、
	PRINTFORMW あとは外来人に好き放題されるのを待つのみとなった
	PRINTFORMW ところが、やってきた外来人たちは、意外なことを言い始める
	PRINTFORMW 君は研究対象として素晴らしい、実に模範的だ
	PRINTFORMW もし我々に協力してくれるなら、ある程度の行動の自由は認めよう、と……
	PRINTFORML このまま拒否し続けても、こいつらは自分を汚し続けるだろう
	PRINTFORML 首を縦に振れば、いくらかは楽になれるのかもしれない
	PRINTFORMW どうするべきだろうか……
	CALL ASK_YN("諦めて受け入れる（奴隷化)", "こんなやつらの奴隷なんてごめんだ")
	IF RESULT == 0
		PRINTFORML %ANAME(MASTER)%が頷くと、彼らは満足気に笑った
		IF IS_MALE(MASTER)
			PRINTFORMW そしてそのペニスに、管理用タグとして、二度と消えない焼き印を刻んだ……
		ELSE
			PRINTFORMW そしてその乳房に、管理用タグとして、二度と消えない焼き印を刻んだ……
		ENDIF
		PRINTFORMW さらにその首に、管理用の首輪が嵌められた
		SETCOLOR COLOR("注意")
		PRINTFORMW %ANAME(MASTER)%は外来人たちの研究用奴隷となりました
		RESETCOLOR
		TALENT:MASTER:研究用奴隷の烙印 = 1
		CFLAG:MASTER:1 = GET_COUNTRY_FROM_ID(COUNTRY_GAIRAI)
		CFLAG:MASTER:9 = 0
		FOR LOCAL:0, 0, CHARANUM
			IF TALENT:(LOCAL:0):外来人
				TALENT:(LOCAL:0):合意 = 1
				CFLAG:(LOCAL:0):2 = MAX(CFLAG:(LOCAL:0):2, 500)
				CFLAG:(LOCAL:0):3 = MAX(CFLAG:(LOCAL:0):3, 500)
			ENDIF
		NEXT
		RETURN 1
	ELSE
		PRINTFORML そうかと、%ANAME(MASTER)%の拒否を特に気にした風でもなく外来人たちは受け入れる
		PRINTFORML それは仕方ない、ではこのまま研究に入るよと、%ANAME(MASTER)%に群がっていく……
	ENDIF
ENDIF
;全員の調教参加フラグを解除
CVARSET CFLAG, 6, 0

;4回目以降、1/5の確率で外来に寝返った顔見知りのキャラが調教者になる
IF FLAG:47 >= 4 && RAND:5 == 0
	LOCAL:1 = 0
	FOR LOCAL:0, 0, CHARANUM
		IF CFLAG:(LOCAL:0):面識 && NO:(LOCAL:0) < 2000 && CFLAG:(LOCAL:0):所属 == CFLAG:MASTER:捕虜先 && TALENT:(LOCAL:0):研究用奴隷の烙印 && !RAND:2
			候補:候補数 = LOCAL:0
			候補数 ++
		ENDIF
	NEXT
	IF 候補数
		CALL FISHER_YATES_SHAFFLE(候補数)
		FOR LOCAL, 0, MIN(候補数, 4)
			参加者:参加者数 = 候補:(SHAFFLE_ARRAY:(LOCAL:0))
			CFLAG:(参加者:参加者数):6 = 1
			参加者数 ++
		NEXT
		IF 参加者数
			LOCALS:0 = 
			FOR LOCAL:0, 0, 参加者数
				IF LOCALS:0 == ""
					LOCALS:0 = %ANAME(参加者:LOCAL)%
				ELSE
					LOCALS:0 = %LOCALS:0%、%ANAME(参加者:LOCAL)%
				ENDIF
			NEXT
			DRAWLINE
			PRINTFORML 調教の時間が近づくと、%ANAME(MASTER)%はいつものように調教部屋で拘束され、
			PRINTFORMW あとは男達に汚されるのを待つのみとなった
			IF 参加者数
				PRINTFORMW やってきた外来人は、%ANAME(MASTER)%が良く見知った相手を連れてきていた
				PRINTFORMW %LOCALS:0%…
				PRINTFORMW かつての面影は既になく、どこか虚ろで生気のない瞳をしている
				PRINTFORMW 怪しげなヘッドギアやケーブルをあちこちに取り付けられているというのに、皆それを疑問にも思っていないようだった
				IF IS_FEMALE(参加者:0)
					PRINTFORMW 事前にたっぷりと犯されてきたのだろう、両方の穴は既に愛液と精液でドロドロに濡れている
					IF PENIS(MASTER)
						PRINTFORMW 性欲に満ちた視線は、%ANAME(MASTER)%ではなく、%ANAME(MASTER)%のいきり立った男根に注がれていた…
					ELSE
						PRINTFORMW 性欲に満ちた視線は、%ANAME(MASTER)%ではなく、%ANAME(MASTER)%のカラダに対して注がれていた…
					ENDIF
				ELSE
					PRINTFORMW 事前にたっぷりと犯されてきたのだろう、全身は白濁にまみれている
					IF PENIS(MASTER)
						PRINTFORMW 性欲に満ちた視線は、%ANAME(MASTER)%ではなく、%ANAME(MASTER)%のいきり立った男根に注がれていた…
					ELSE
						PRINTFORMW 性欲に満ちた視線は、%ANAME(MASTER)%ではなく、%ANAME(MASTER)%のカラダに対して注がれていた…
					ENDIF
				ENDIF
			ENDIF
			FLAG:29 = 1
		ENDIF
	ENDIF
ENDIF
IF 参加者数
	ループ数 = MIN(4, VARSIZE("参加者") - 参加者数)
ELSE
	ループ数 = 4
ENDIF

FOR LOCAL:0, 0, ループ数
	;確率で犬豚が対象に
	IF !RAND:8
		FOR LOCAL:1, 0, CHARANUM
			IF CFLAG:(LOCAL:1):所属 == 外来 && IS_ANIMAL(LOCAL:1) && !CFLAG:(LOCAL:1):6
				参加者:参加者数 =  LOCAL:1
				参加者数 ++
				CFLAG:(LOCAL:1):6 = 1
				BREAK
			ENDIF
		NEXT
		CALL ADD_ANIMAL(@"\@ RAND:2 ? 犬 # 豚 \@", LOCAL:6)
		CFLAG:(CHARANUM -1):6 = 1
		参加者:参加者数 =  CHARANUM - 1
		参加者数 ++
	;普通に外来を選出
	ELSE
		FOR LOCAL:1, 0, CHARANUM
			IF TALENT:(LOCAL:1):外来人 && !CFLAG:(LOCAL:1):6 && CFLAG:(LOCAL:1):所属 == 外来
				参加者:参加者数 =  LOCAL:1
				参加者数 ++
				CFLAG:(LOCAL:1):6 = 1
				CFLAG:(LOCAL:1):64 = 1
				CFLAG:(LOCAL:1):65 = 1
				ABL:(LOCAL:1):欲望 = 5
				ABL:(LOCAL:1):奉仕 = 5
				ABL:(LOCAL:1):性技 = 10
				ABL:(LOCAL:1):主導度Ｕ = 600
				ABL:(LOCAL:1):倒錯度 = 600
				TALENT:(LOCAL:0):性別 = GAIRAI_SEX_VS(MASTER)
				TALENT:(LOCAL:1):快感に素直 = 1
				TALENT:(LOCAL:1):絶倫 = 1
				IF !PENIS(LOCAL:1) && PENIS(MASTER)
					ABL:(LOCAL:1):性交 = 0
					ABL:(LOCAL:1):Ｖ感 = 4
					TALENT:(LOCAL:1):濡れやすい = 1
					EXP:(LOCAL:1):♀♂性交回数 = 500
					EXP:(LOCAL:1):絶頂経験 = 3000
				ELSE
					ABL:(LOCAL:1):性交 = 15
					EXP:(LOCAL:1):♂♀性交回数 = 500
					EXP:(LOCAL:1):♂Ａ性交回数 = 500
					EXP:(LOCAL:1):絶頂経験 = 3000
					IF PENIS(LOCAL:1)
						ABL:(LOCAL:1):射精 = 3000
					ENDIF
				ENDIF
				FOR LOCAL:2, 0, 900
					COM_EXP:(LOCAL:1):(LOCAL:2) = 1000
				NEXT
				BREAK
			ENDIF
		NEXT
	ENDIF
NEXT

FOR LOCAL:0, 0, 参加者数
	CFLAG:(参加者:(LOCAL:0)):6 = 1
NEXT
;逆調教モード
FLAG:12 = 4
;ウフフモード
FLAG:50 = 1
;アイテムを一通り追加
ITEM:A_ローター = 1
ITEM:A_バイブ = 1
ITEM:A_アナルバイブ = 1
ITEM:A_ペニスバンド = 1
ITEM:A_オナホール = 1
ITEM:A_クリキャップ = 1
ITEM:A_ニプルキャップ = 1
ITEM:A_針 = 1
ITEM:A_鞭 = 1
ITEM:A_媚薬 = 99
ITEM:A_排卵誘発剤 = 99
IF GAIRAI_SEX_VS(MASTER) != 1 || !PENIS(MASTER)
	ITEM:A_ローション = 99
	ITEM:A_ペニスバンド = 1
ENDIF
;回数をカウント
FLAG:47 ++
;解放カウンタをリセット
CFLAG:MASTER:43 = 0

