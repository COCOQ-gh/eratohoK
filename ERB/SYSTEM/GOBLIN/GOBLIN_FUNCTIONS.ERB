;--------------------------------------
;ホフゴブリン出現イベント
;出現できたら1、できなければ0をかえす
;都市 = 最初に奪う都市 指定しなければ野盗と同一の方式
;メッセージフラグ = 汎用メッセージ表示フラグ　指定しなければ表示
;--------------------------------------
@GOBLIN_RISE(都市:0 = -1, メッセージフラグ = 1)
#DIM ゴブリン
#DIM メッセージフラグ
#DIM 都市, 10
#DIM 勢力
;ホフゴブリン勢力を作成
CALL GOBLIN_INIT()
ゴブリン = RESULT
;作れなかったら戻す
SIF ゴブリン == -1
	RETURN 0

;引数で奪う都市が指定されていなければ、BANDIT_RISE_SELECT_CITY()を流用
IF 都市:0 < 0 || 都市:0 >= CITY_NUM
	CALL BANDIT_RISE_SELECT_CITY()
	FOR LOCAL, 0, VARSIZE("都市")
		SIF RESULT:LOCAL == -1
			BREAK
		都市:LOCAL = RESULT:LOCAL
	NEXT
	;多分ないはずなんだけど、奪えなかったら諦め
	IF 都市:0 == -1
		RETURN
	ENDIF
	FOR LOCAL, 0, VARSIZE("都市")
		SIF 都市:LOCAL == -1
			BREAK
		CALL TAKEOVER_CITY_FROM_NO(ゴブリン, 都市:LOCAL)
	NEXT
ELSE
	勢力 = CITY_OWNER:(都市:0)
	FOR LOCAL, 0, GOBLIN_RANK
		SIF GET_OWN_CITY(勢力) <= 3
			BREAK
		FOR LOCAL:1, 1, MAX_CITY
			IF CITY_OWNER:(LOCAL:1) == 勢力 && !RAND:3
				CALL TAKEOVER_CITY_FROM_NO(ゴブリン, 都市)
				BREAK
			ENDIF
		NEXT
	NEXT
ENDIF


IF メッセージフラグ
	DRAWLINE
	SETCOLOR COLOR("警告")
	PRINTFORMW 日頃から虐げられ、溜まっていたホフゴブリンたちの鬱憤が、とうとう爆発しました！
	PRINTFORMW 彼らは反旗を翻し、%CITY_NAME:(都市)%\@ GET_OWN_CITY(ゴブリン) > 1 ? など # \@を占拠したようです
	PRINTFORMW これに伴い、幻想郷の各勢力が異変解決の準備を始めたようです…
	RESETCOLOR
	DRAWLINE
ENDIF

RETURN 1

;--------------------------------------
;ターンエンド時のホフゴブリンの処理
;--------------------------------------
@TURNEND_GOBLIN
#DIM ゴブリン

IF !SP_COUNTRY_APPEARED:特殊勢力出現_ホフゴブリン
	;ホフゴブリンの蜂起
	CALL SLG_GOBLIN_RISE
	RETURN -1
ENDIF

IF SP_COUNTRY_APPEARED:特殊勢力出現_ホフゴブリン == 1
	;ホフゴブリンの番号を取得(ID:299)
	ゴブリン = GET_COUNTRY_FROM_ID(COUNTRY_GOBLIN)
	IF ゴブリン == -1
		DRAWLINE
		SETCOLOR COLOR("注意")
		PRINTFORML
		PRINTFORML
		PRINTFORML
		PRINTFORMW 壊滅的な被害を受けたホフゴブリンは、ちりぢりに四散していきました
		PRINTFORMW 八雲紫が「めっ☆（滅っ）」したようなので、しばらくは大人しくしていることでしょう……
		PRINTFORML
		PRINTFORML
		PRINTFORML
		RESETCOLOR
		;ホフゴブリンを削除する
		LOCAL:1 = CHARANUM
		FOR LOCAL:0, 0, LOCAL:1
			LOCAL:2 = LOCAL:1 - LOCAL:0 - 1
			IF TALENT:(LOCAL:2):ホフゴブリン
				CALL DELETE_CHARA(LOCAL:2)
			ENDIF
		NEXT
		SP_COUNTRY_APPEARED:特殊勢力出現_ホフゴブリン = 2
		RETURN -1
	ENDIF

	;兵力の増える処理
	IF DAY % 3 == 0
		DRAWLINE
		LOCAL:0 = MAX(RAND:3000, 1000)
		LOCAL:0 += RAND:500 * GOBLIN_RANK
		PRINTFORML ホフゴブリンにつけばおこぼれにあずかれると聞いた野良妖怪たちが、次々と寝返っているようです……
		PRINTFORML ホフゴブリンの兵力が{LOCAL:0}増加した
		COUNTRY_SOLDIER:(ゴブリン) += LOCAL:0
	ENDIF
	;4ターンに1回、特別な徴兵
	CALL GOBLIN_SPECIAL_REQRUITMENT(DAY % 4 == 0)
	;調教処理
	DEBUGPRINTFORML {DAY, 3}調教：ホフゴブリン
	CALL TRAIN_BY_GOBLIN
ENDIF
;--------------------------------------
;ホフゴブリンの初期化処理
;--------------------------------------
@GOBLIN_INIT(ARG:0)
#DIM LCOUNT
VARSET LOCAL

LOCAL:4 = GET_NEW_COUNTRY()
;作れなかったらなしで
IF LOCAL:4 == -1
	RETURN -1
ENDIF
COUNTRY_COLOR:(LOCAL:4) = 0x2B5C1B
COUNTRY_SOLDIER:(LOCAL:4) = 20000 + GOBLIN_RANK
COUNTRY_AI_TYPE:(LOCAL:4) = AI_ホフゴブリン
COUNTRY_EVENT_ID:(LOCAL:4) = COUNTRY_GOBLIN

CALL ADD_VOID_CHARA()
LOCAL = RESULT
SELECTCASE GOBLIN_NAME
	CASE 0
		NAME:LOCAL = ホフゴブリン
		CALLNAME:LOCAL = ホフゴブリン
		CSTR:LOCAL:0 = ホフゴブリン
		CSTR:LOCAL:1 = ホフゴブリン
		CSTR:LOCAL:3 = ホフゴブリン
		CSTR:LOCAL:4 = ホフゴブリン
		CSTR:LOCAL:5 = ホフゴブリン
		CSTR:LOCAL:6 = ホフゴブリン
	CASE 1
		NAME:LOCAL = ゴブリンキング
		CALLNAME:LOCAL = ゴブリンキング
		CSTR:LOCAL:0 = ゴブリンキング
		CSTR:LOCAL:1 = ゴブリンキング
		CSTR:LOCAL:3 = ゴブリンキング
		CSTR:LOCAL:4 = ゴブリンキング
		CSTR:LOCAL:5 = ゴブリンキング
		CSTR:LOCAL:6 = ゴブリンキング
	CASE 2
		TARGET = LOCAL
		CALL SET_RANDOM_NAME_K(LOCAL)
		NAME:LOCAL = %CSTR:LOCAL:1%
		CALLNAME:LOCAL = %CSTR:LOCAL:1%
ENDSELECT
MAXBASE:LOCAL:体力 = 3000
MAXBASE:LOCAL:気力 = 3000
MAXBASE:LOCAL:精神力 = 1500
BASE:LOCAL:体力 = MAXBASE:LOCAL:体力
BASE:LOCAL:気力 = MAXBASE:LOCAL:気力
BASE:LOCAL:精神力 = MAXBASE:LOCAL:精神力
ABL:LOCAL:Ｃ感 = 3
ABL:LOCAL:欲望 = 8
ABL:LOCAL:性技 = 3
ABL:LOCAL:性知識 = 5
ABL:LOCAL:奉仕 = 1
ABL:LOCAL:性交 = 10
ABL:LOCAL:射精 = 5
EXP:LOCAL:絶頂経験 = 500
ABL:LOCAL:武闘 = 50 + RAND(5, 15) + 5 * GOBLIN_RANK
ABL:LOCAL:知略 = 45 + RAND(5, 15) + 3 * GOBLIN_RANK
ABL:LOCAL:政治 = 40 + RAND(5, 10) + 3 * GOBLIN_RANK
ABL:LOCAL:歌唱 = 10
ABL:LOCAL:料理 = 10
TALENT:LOCAL:絶倫 = 1
TALENT:LOCAL:ホフゴブリン = 1
TALENT:LOCAL:陰毛現在値 = 陰毛_標準
TALENT:LOCAL:陰毛目標値 = 陰毛_標準
;所属をホフゴブリンにする
CFLAG:LOCAL:1 = LOCAL:4
CALL NEWCHARA_INIT(LOCAL)
COUNTRY_BOSS:(LOCAL:4) = GET_ID(LOCAL)


FOR LCOUNT, 0, 14
	CALL ADD_VOID_CHARA()
	LOCAL = RESULT
	NAME:LOCAL = ホフゴブリン%UNICODE(0xFF21 + LCOUNT)%
	CALLNAME:LOCAL = ホフゴブリン%UNICODE(0xFF21 + LCOUNT)%
	MAXBASE:LOCAL:体力 = 3000
	MAXBASE:LOCAL:気力 = 3000
	MAXBASE:LOCAL:精神力 = 1500
	BASE:LOCAL:体力 = MAXBASE:LOCAL:体力
	BASE:LOCAL:気力 = MAXBASE:LOCAL:気力
	BASE:LOCAL:精神力 = MAXBASE:LOCAL:精神力
	ABL:LOCAL:Ｃ感 = 3
	ABL:LOCAL:欲望 = 8
	ABL:LOCAL:性技 = 3
	ABL:LOCAL:性知識 = 5
	ABL:LOCAL:奉仕 = 1
	ABL:LOCAL:性交 = 10
	ABL:LOCAL:射精 = 5
	ABL:LOCAL:肝臓 = 3
	EXP:LOCAL:絶頂経験 = 500
	ABL:LOCAL:武闘 = 40 + RAND:15 + 5 * GOBLIN_RANK
	ABL:LOCAL:知略 = 35 + RAND:15 + 3 * GOBLIN_RANK
	ABL:LOCAL:政治 = 30 + RAND:10 + 3 * GOBLIN_RANK
	ABL:LOCAL:歌唱 = 10
	ABL:LOCAL:料理 = 10
	TALENT:LOCAL:絶倫 = 1
	TALENT:LOCAL:ホフゴブリン = 1
	TALENT:LOCAL:陰毛現在値 = 陰毛_標準
	TALENT:LOCAL:陰毛目標値 = 陰毛_標準
	;所属をホフゴブリンにする
	CFLAG:LOCAL:1 = LOCAL:4
	CALL NEWCHARA_INIT(LOCAL)
NEXT
SP_COUNTRY_APPEARED:特殊勢力出現_ホフゴブリン = 1

RETURN LOCAL:4

;--------------------------------------
;ホフゴブリンの侵攻イベントを実行するSLGイベント。
;判定通ったら素のGOBLIN_RISEを呼ぶだけ。
;25期以降、50期までに徐々に確率が高まっていく。既に発生していたらなし。
;--------------------------------------
@SLG_GOBLIN_RISE()
#DIM 紅魔館
#DIM レミリア

;既に出現しているか、外来人なし設定なら発動しない
SIF SP_COUNTRY_APPEARED:特殊勢力出現_ホフゴブリン || !GOBLIN_RANK
	RETURN -1

;20期以降、確率判定をクリアしていること
SIF !(DAY >= 20 && DAY - 10 > RAND:100)
	RETURN -1

レミリア = GET_COUNTRY_FROM_BOSS_NAME("レミリア")
紅魔館 = GET_CITYNUMBER("紅魔館")
;レミリアが君主やってて、紅魔館がマップに存在し、レミリアの都市数が4以上で、レミリアが紅魔館を占拠しているなら、紅魔館を占領する
IF レミリア != -1 && 紅魔館 && GET_OWN_CITY(レミリア) >= 4 && CITY_OWNER:紅魔館 == レミリア
	CALL GOBLIN_RISE(紅魔館)
	IF RESULT
		CALL COLORPRINTFORM(@"突然のことに動揺したレミリア勢力に、1ターンのクールタイムが付与されます！", COLOR("警告"), "W")
		FOR LOCAL, 0, CHARANUM
			SIF CFLAG:LOCAL:所属 == レミリア	
				CALL ADD_COOLTIME(LOCAL, 1)
		NEXT
	ENDIF
;レミリアが君主でない、または紅魔館がないなら、ランダムに決めてしまえ
ELSEIF (レミリア == -1 || !紅魔館)
	CALL GOBLIN_RISE()
ENDIF

;--------------------------------------
;ホフゴブリンの定期イベント。
;陥落済みキャラを使って兵数を増やす
;--------------------------------------
@GOBLIN_SPECIAL_REQRUITMENT(条件 = 1)
#DIM ゴブリン
#DIM 条件
#DIM 候補, 1000
#DIM 候補数
#DIM 対象
#DIM メッセージ
VARSET 候補, -1
VARSET 候補数

ゴブリン = GET_COUNTRY_FROM_ID(COUNTRY_GOBLIN)

;ゴブリン勢力があり、条件を満たしている
SIF ゴブリン == -1 || !条件
RETURN -1

FOR LOCAL, 0, CHARANUM
	;ゴブリン所属で、捕虜でなく、陥落済み
	IF CFLAG:LOCAL:所属 == ゴブリン && !CFLAG:LOCAL:9 && IS_FEMALE(LOCAL) && TALENT:LOCAL:ゴブリンの性奴隷
		候補:候補数 = LOCAL
		候補数 ++
	ENDIF
NEXT

SIF 候補数 < 1
	RETURN -1

CALL FISHER_YATES_SHAFFLE(候補数)

対象 = 候補:(SHAFFLE_ARRAY:0)

SIF 対象 == -1 && CONFIG:200
	RETURN -1

DRAWLINE
SETCOLOR COLOR("桃")
PRINTFORML ホフゴブリンは\@CONFIG:200 ? # %ANAME(対象)%を、\@兵士の募集活動に駆り出したようだ……
PRINTFORML 
メッセージ = CONFIG:200 ? 4 # RAND:4
SELECTCASE メッセージ
	CASE 0
		PRINTFORMW 彼らは近くの人里に繰り出した
		PRINTFORML %ANAME(対象)%は彼らの一歩後ろを歩き、付き従っている
		PRINTFORML ぱっと見は普段の彼女であり、いたって普通だった
		PRINTFORMW ……その足取りは、%ANAME(対象)%にしては珍しいほどふらついていたが
		PRINTFORML 彼らは里の中心、広場まで来ると、そこで里の男達をかき集めた
		PRINTFORML 何事かと思った野次馬が人妖問わず集まり、広場はあっという間に埋まる
		PRINTFORMW そこでホフゴブリンは、全員によく聞こえるよう、大声でスピーチを始めた
		PRINTFORMW 俺たちに参加すればものすごくいいことがある。それを今日は見せてやる……
		PRINTFORML ホフゴブリンが%ANAME(対象)%に目配せすると、彼女はおもむろに服を脱ぎ捨てた
		PRINTFORML 突如として露わになる美しい肢体に、皆の目は釘付けになる
		PRINTFORMW \@ TATOO:(対象):タトゥー_秘部 != "" ? その下腹には「%TATOO:対象:タトゥー_秘部%」のタトゥーが刻まれ、 # \@両穴には太いバイブがねじ込まれていた
		PRINTFORML この女は俺たちの奴隷だ。今日はコイツを連れてきたが、他にも女はいくらでもいる……
		PRINTFORML %ANAME(対象)%に己の肉棒をしゃぶらせながら、ホフゴブリンたちは勧誘の言葉を並べたてる
		PRINTFORMW やがてホフゴブリンは射精し、%ANAME(対象)%の顔にぶちまけると、%ANAME(対象)%を抱え、群衆の中に放り投げる
		PRINTFORMW この女はサービスだ。好きにしていいぞ
		PRINTFORMW ホフゴブリンがそう言うと、男達は目の色を変え、%ANAME(対象)%に群がった……
	CASE 1
		CALL SET_PIERCE_RANDOM(対象, 0)
		SIF RESULT == -1
			RESULT = ピアス_乳首
		PRINTFORMW 彼らは近くの人里に繰り出した
		PRINTFORML %ANAME(対象)%はリードつきの首輪を嵌められ、里の目抜き通りを歩かされている
		PRINTFORML 口にはギャグボールを嵌められ、羽織っているのは肝心なところをまるで隠さない奴隷用ボンテージ
		PRINTFORML 全身にはあちこちに卑猥な落書きが施されている。さらに、%GET_PIERCE_NAME(RESULT)%に痛々しいピアスが取り付けられている
		PRINTFORMW 拠点を出る前に何度も「使われて」おり、全身べっとりと白いものにまみれている。特にその両穴は、でろでろと白濁を垂れ流す
		PRINTFORML 腕には頑丈な枷が嵌められており、抵抗などできるはずもなかった
		PRINTFORMW もっとも、ホフゴブリン"様"たちの忠実なしもべである%ANAME(対象)%に、そんな大それた考えはあるまいが……
		PRINTFORML 里の男達は、練り歩く彼らをじっと眺めている
		PRINTFORMW 正しくは、%ANAME(対象)%の淫らな姿を
		PRINTFORMW ホフゴブリンはニヤニヤと笑いながら言う
		PRINTFORML 俺たちの奴隷がそんなに気になるか、俺たちに参加すればコイツ以外にもヤり放題だ
		PRINTFORMW 特別に今回は、お前らにコイツを好きにさせてやるよ……
		PRINTFORMW ホフゴブリンがそう言うと、男達は目の色を変え、%ANAME(対象)%に群がった……
	CASE 2
		PRINTFORMW 彼らは%ANAME(対象)%を、他の奴隷と一緒に肉便器として提供した
		PRINTFORMW 彼女らは屋外に設けられた「特設便所」にて、壁尻の状態で備え付けられた
		PRINTFORML 人妖問わず、さまざまな男達が訪れては、%ANAME(対象)%の両穴を使っていく
		PRINTFORML 自らモノを扱いてちり紙に射精するときの気軽さで、簡単に膣内射精していく
		PRINTFORMW 使い捨てられる被虐と快楽に、%ANAME(対象)%は何度も激しく絶頂する……
		PRINTFORMW やがてコトが終わるころには、%ANAME(対象)%の%STR_BODY("尻", 対象)%には両手に余る正の字が書き込まれていた
		PRINTFORML 彼女の穴は大変評判がよかったらしい
		PRINTFORMW %ANAME(対象)%はその「褒美」として、ホフゴブリン"様"たちのモノをたっぷりとしゃぶらせてもらった……
	CASE 3
		PRINTFORMW 彼らは%ANAME(対象)%を、他の奴隷と一緒に肉便器として提供した
		PRINTFORML 彼女らは屋外に設けられた「特設便所」にて、グローリーホールをしたようだ
		PRINTFORMW 人妖問わず、さまざまな男達が訪れては、壁越しにペニスを突き出してくる
		PRINTFORML 太いもの、細いもの、逞しいものから恥垢を溜めたもの
		PRINTFORML それら全てを、%ANAME(対象)%は顔を蕩かし、股を濡らしながら舐めしゃぶっていく
		PRINTFORMW 官能の炎は%ANAME(対象)%の中で激しく燃え上がり、彼女は仕事中に何度も自慰をし、絶頂した
		PRINTFORMW やがてコトが終わるころには、何度も白濁を受けた上半身に、白く汚れていないところはないほどになっていた
		PRINTFORML 彼女の口技は大変評判がよかったらしい
		PRINTFORMW %ANAME(対象)%はその「褒美」として、疼く身体をホフゴブリン"様"たちにたっぷりと使っていただいた……
ENDSELECT

PRINTFORML
SETCOLOR COLOR("注意")
LOCAL:0 = MAX(RAND:3000, 1000)
PRINTFORML キャンペーンは好評だったようだ……
PRINTFORMW ホフゴブリンの兵力が{LOCAL:0}増加した
RESETCOLOR
COUNTRY_SOLDIER:(ゴブリン) += LOCAL:0
SIF CONFIG:200
	CALL KOJO_SPECIAL_TURNEND_EVENT(対象, COUNTRY_GOBLIN, メッセージ)
