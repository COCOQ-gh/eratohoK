@MEMORY_PREVIOUS_ARMY

FOR LOCAL:0, 0, MAX_COUNTRY
	FOR LOCAL:1, 0, MAX_UNIT
		UNIT_SOLDIER_PREV:(LOCAL:0):(LOCAL:1) = UNIT_SOLDIER_PREV:(LOCAL:0):(LOCAL:1)
	NEXT
NEXT

FOR LOCAL, 0, MAX_CITY
	CITY_SOLDIER_PREV = CITY_SOLDIER
NEXT

;ARG:0 = 1で強制初期化のみ
;ARG:1 = 1 or -1でページ操作
@SHOW_CITY_ARMY(ARG:0 = 0, ARG:1 = 0)
#DIM ONCE=0
#DIM LINE
#DIM WIDTH_CITYNAME = 30
#DIM ARR, MAX_CITY
#DIM MAX_PAGE
#DIM PTR
#DIM CITY_PER_PAGE
#DIM WIDTH
#DIM FIRST_LINE
CITY_PER_PAGE = (MENU_HEIGHT-2-2)

IF ARG:0 || !ONCE
	ONCE = 1
	VARSET ARR, -1
	PTR = 0
	
	FOR LOCAL, 0, CITY_NUM+1
		IF CITY_OWNER:(LOCAL) == CFLAG:MASTER:所属
			ARR:PTR = LOCAL
			PTR++
		ENDIF
	NEXT

	MAX_PAGE = (PTR/CITY_PER_PAGE)
	SIF PTR/CITY_PER_PAGE != 0
		MAX_PAGE++
	SIF ARG:0
		RETURN
ENDIF

SELECTCASE ARG:1
	CASE 1
		FLAG:201++
		SIF FLAG:201 >= MAX_PAGE
			FLAG:201 = 0
		RETURN
	CASE -1
		FLAG:201--
		SIF FLAG:201 < 0
			FLAG:201 = MAX_PAGE
		RETURN
	CASE 2
		FLAG:201 = MAX_PAGE - 1
		SIF FLAG:201 < 0
			FLAG:201 = MAX_PAGE
		RETURN
	CASE -2
		FLAG:201 = 0
		RETURN
ENDSELECT

CALL PRINT_SLG_MENU(0)

PRINTFORML %TOSTR_SPACE( (WIDTH_CITYNAME-6)/2 )%都市名%TOSTR_SPACE( (WIDTH_CITYNAME-6+1)/2 )%┃  経済  ┃防衛兵数┃  守将  ┃前期兵損┃ 危険度 ┃
CALL PRINT_SLG_MENU(1)
PRINTL ━━━━━━━━━━━━━━━╋━━━━╋━━━━╋━━━━╋━━━━╋━━━━┫
FOR LINE, 0, CITY_PER_PAGE
	LOCAL = ARR:(LINE + CITY_PER_PAGE*FLAG:201)
	CALL PRINT_SLG_MENU(LINE+2)

	IF LOCAL >= 0
		LOCALS =  %CITY_NAME:LOCAL%%TOSTR_SPACE(WIDTH_CITYNAME-STRLENS(CITY_NAME:LOCAL))%
		PRINTBUTTON LOCALS, 1000+LOCAL
		PRINT ┃
		PRINTPLAINFORM  {(CITY_ECONOMY:LOCAL)/100, 7, RIGHT}┃
		LOCALS = {CITY_SOLDIER:LOCAL, 8, RIGHT}
		IF IS_STAY_ENEMY_UNIT(LOCAL) == 1
			SETCOLOR COLOR("警告")
			PRINTFORM %LOCALS%
			RESETCOLOR
		ELSE
			PRINTBUTTON LOCALS, 200+LOCAL
		ENDIF
		PRINTPLAINFORM ┃
		LOCALS = \@ GET_CITY_COMMANDER(LOCAL, 0) != -1 ? %"有", 8, RIGHT% # %"無", 8, RIGHT% \@
		IF IS_STAY_ENEMY_UNIT(LOCAL) == 1
			SETCOLOR COLOR("警告")
			PRINTFORM %LOCALS%
			RESETCOLOR
		ELSE
			PRINTBUTTON LOCALS, 400 + LOCAL
		ENDIF
		PRINTPLAINFORM ┃
		PRINTPLAINFORM  {CITY_SOLDIER_PREV:LOCAL, 7, RIGHT}┃
		SELECTCASE GET_CITY_RISK(LOCAL)
			CASE 0
				LOCALS '= "  安全  "
			CASE 1
				LOCALS '= "  注意  "
			CASE 2
				LOCALS '= "  注意  "
			CASE 3
				LOCALS '= "  注意  "
			CASE 4
				LOCALS '= "  前線  "
				SETCOLOR COLOR("オレンジ")
			CASE 5
				LOCALS '= " 敵発見 "
				SETCOLOR COLOR("警告")
			CASE 6
				LOCALS '= " 交戦中 "
				SETCOLOR COLOR("警告")
		ENDSELECT
		
		PRINTPLAINFORM %LOCALS%
		RESETCOLOR
		PRINT ┃
		
	ELSE
	ENDIF
	PRINTL 
NEXT

CALL PRINT_SLG_MENU(MENU_HEIGHT-2)
PRINTL 
CALL PRINT_SLG_MENU(MENU_HEIGHT-1)
PRINTFORM                              
IF FLAG:201 >= 2
	PRINTBUTTON "<<<", 44
	PRINT
ELSE
	SETCOLOR COLOR("選択不可")
	PRINTPLAINFORM <<<
	RESETCOLOR
	PRINT
ENDIF
IF FLAG:201 >= 1
	PRINTBUTTON "<<", 54
	PRINT
ELSE
	SETCOLOR COLOR("選択不可")
	PRINTPLAINFORM <<<
	RESETCOLOR
	PRINT
ENDIF
PRINTFORM {(FLAG:201)+1, 2, RIGHT} / {MAX_PAGE, 2, LEFT}
PRINT     
IF MAX_PAGE-1 >= FLAG:201 
	PRINTBUTTON ">>", 56
	PRINT
ELSE
	SETCOLOR COLOR("選択不可")
	PRINTPLAINFORM >>>
	RESETCOLOR
	PRINT
ENDIF
PRINT     
IF MAX_PAGE-2 >= FLAG:201 
	PRINTBUTTON ">>>", 66
	PRINT
ELSE
	SETCOLOR COLOR("選択不可")
	PRINTPLAINFORM >>>
	RESETCOLOR
	PRINT
ENDIF
PRINTL 


CALL SHOW_CITY_INFO(SHOWN_CITY)


@SET_CITY_SOLDIER(ARG)
#DIM FIRST_LINE
#DIM PLUS = 100, 500, 1000, 5000, 10000, 50000, 100000
#DIM ERRMSG = 0

ERRMSG = 0

SIF !INRANGE(ARG, 1, CITY_NUM) || CITY_OWNER:ARG != CFLAG:MASTER:所属
	RETURN 0
SIF IS_STAY_ENEMY_UNIT(ARG)
	RETURN 0


REDRAW 0
;CLEARLINE LINES_SHOP_SLG-27-3-1

LOCAL:11 = CITY_SOLDIER:ARG
FIRST_LINE = LINECOUNT 
$INPUT_LOOP
LOCAL:21 = COUNTRY_SOLDIER:(CFLAG:MASTER:所属) - (LOCAL:11 - CITY_SOLDIER:ARG)
DRAWLINE
PRINTFORML %CITY_NAME:ARG%の防衛兵数を決定してください
PRINTFORML 直接入力も可能です
PRINTFORML 防衛兵数   {CITY_SOLDIER:ARG,8,RIGHT} → {LOCAL:11,8,RIGHT}
PRINTFORML 残存兵数   {COUNTRY_SOLDIER:(CFLAG:MASTER:所属),8,RIGHT} → {LOCAL:21,8,RIGHT}
SETCOLOR COLOR("P-BLUE")
FOR LOCAL , 0, 7
	LOCALS = [+{PLUS:LOCAL}]
	PRINTBUTTON LOCALS, -1000-LOCAL
NEXT
PRINTL 
SETCOLOR COLOR("P-RED")
FOR LOCAL , 0, 7
	LOCALS = [-{PLUS:LOCAL}]
	PRINTBUTTON LOCALS, -10000-LOCAL
NEXT
RESETCOLOR
PRINTL 
PRINTL 
PRINTBUTTON "[確定]", -1
PRINTBUTTON "[キャンセル]", -2
PRINTL
DRAWLINE
PRINTL 

SELECTCASE ERRMSG
	CASE 1
		PRINTFORM 最低でも500の兵数が必要です
	CASE 2
		PRINT 兵数が足りません
ENDSELECT
PRINTL 
REDRAW 1
INPUT

ERRMSG = 0
IF RESULT >= 0
	IF RESULT >= 500
		IF COUNTRY_SOLDIER:(CFLAG:MASTER:所属) + CITY_SOLDIER:ARG < RESULT
			ERRMSG = 2
		ELSE
			GOTO OUT_OF_INPUT_LOOP
		ENDIF
	ELSE
		ERRMSG = 1
	ENDIF
ELSE
	LOCAL:0 = -1
	
	SIF RESULT == -1
		GOTO OUT_OF_INPUT_LOOP
		
	SIF RESULT == -2
		RETURN
	
	IF ABS(RESULT) >= 1000 && ABS(RESULT) <= 1001 + CITY_NUM
		LOCAL:0 = ABS(RESULT)-1000
		LOCAL:1 = 1
	ELSEIF ABS(RESULT) >= 10000 && ABS(RESULT) < 10100
		LOCAL:0 = ABS(RESULT)-10000
		LOCAL:1 = -1
	ENDIF
	
	IF (LOCAL:0 >= 0 && LOCAL:0 < 7)
		LOCAL:11 = LOCAL:11 + (PLUS:(LOCAL:0))*LOCAL:1
		LOCAL:11 = MIN(LOCAL:11, COUNTRY_SOLDIER:(CFLAG:MASTER:所属) + CITY_SOLDIER:ARG)
		LOCAL:11 = MAX(LOCAL:11, 500)
	ENDIF
ENDIF

REDRAW 0

CLEARLINE LINECOUNT - FIRST_LINE
GOTO INPUT_LOOP

REDRAW 1

$OUT_OF_INPUT_LOOP
LOCAL:21 = COUNTRY_SOLDIER:(CFLAG:MASTER:所属) - (LOCAL:11 - CITY_SOLDIER:ARG)
CITY_SOLDIER:ARG = LOCAL:11
COUNTRY_SOLDIER:(CFLAG:MASTER:所属) = LOCAL:21
