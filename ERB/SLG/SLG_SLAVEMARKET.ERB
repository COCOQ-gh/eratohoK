;-------------------------------------------------
;奴隷市場
;-------------------------------------------------
@SLAVEMARKET
#DIM 対象
#DIM 対象添え字
#DIM 特売
特売 = ID_TO_CHARA(SLAVEMARKET_SPECIALGOODS)
DRAWLINE
PRINTFORML 「よぉ～こそ！　イキのいいのを揃えてますよぉ？」
PRINTFORML %ANAME(MASTER)%は奴隷市場を訪れた
PRINTFORML ボロボロの服を着た女達が檻に入れられ、並べられている
PRINTFORML 係の者は、使えそうな奴隷のリストを渡してきた……
PRINTFORML 現在の金:{MONEY}
DRAWLINE
$SHOW_LOOP
FOR LOCAL, 0, SLAVEMARKET_MAX_GOODS
	LOCAL:1 = ID_TO_CHARA(SLAVEMARKET_GOODS:LOCAL)
	IF LOCAL:1 != -1
		PRINTFORM [{LOCAL}]%ANAME(LOCAL:1), 16, RIGHT% - 金{SLAVEMARKET_CALC_PRICE(LOCAL:1), 6, RIGHT}
		IF LOCAL:1 == 特売
			CALL COLORPRINTFORM(" 特売!", COLOR("注意"))
		ENDIF
		IF TALENT:(LOCAL:1):研究用奴隷の烙印
			CALL COLORPRINTFORM(" 研究用", COLOR("注意"))
		ENDIF
		IF TALENT:(LOCAL:1):ゴブリンの性奴隷
			CALL COLORPRINTFORM(" 性奴隷", COLOR("注意"))
		ENDIF
		IF TALENT:(LOCAL:1):野盗の肉便器
			CALL COLORPRINTFORM(" 肉便器", COLOR("注意"))
		ENDIF
		PRINTL
	ELSE
		SETCOLOR COLOR("選択不可")
		PRINTPLAINFORM [{LOCAL}]%"品切れ", 16, RIGHT% - 金{0, 6, RIGHT}
		RESETCOLOR
		PRINTL
	ENDIF
NEXT
DRAWLINE
PRINTFORML [99] 戻る
$INPUT_LOOP
INPUT
IF RESULT == 99
	RETURN 0
ELSEIF RESULT < 0 || RESULT >= SLAVEMARKET_MAX_GOODS
	GOTO INPUT_LOOP
ELSEIF !SLAVEMARKET_GOODS:RESULT
	PRINTFORML 品切れです
	GOTO INPUT_LOOP
ELSE
	対象 = ID_TO_CHARA(SLAVEMARKET_GOODS:RESULT)
	対象添え字 = RESULT
	PRINTFORML 「へへ、その女ァ%NAME_FORMAL(対象)%ってんです」
	PRINTFORML 「イキのいい新鮮な奴隷ですよ、いかがです？」
	IF TALENT:対象:研究用奴隷の烙印
		PRINTFORML 「怪しげな連中が、研究用サンプルを払い下げるつって持ってきたんですよぉ」
		PRINTFORML 「なんの研究だか知らんが、ひひひ、上等に出来上がってまさァな」
	ENDIF
	IF TALENT:対象:ゴブリンの性奴隷
		PRINTFORML 「実はこのメス、下等生物どもの性奴隷をやってましてね？　飽きて捨てられたわけですが」
		PRINTFORML 「あの連中が飼うにはちょっと勿体ない上玉だと思いませんかァ？　ヒヒッ」
	ENDIF
	IF TALENT:対象:野盗の肉便器
		PRINTFORML 「コイツはあるところで"便器"やってましてね、言っちまえば中古ですが、使用感は格別ですぜ」
		PRINTFORML 「なんせこの私も使ったんでねぇ！　ヒッヒッヒ！」
	ENDIF
	SIF 対象 == 特売
		PRINTFORML 「ちょっと"訳あり"でしてね、特売ってことで値引きさせていただいてやす」
	PRINTFORML 「今なら{SLAVEMARKET_CALC_PRICE(対象)}でお譲りいたしやす」
	IF IS_LOVER(対象)
		PRINTFORML 「……ヒヒッ、コイツアンタの恋人だろ？」
		PRINTFORML 「目ぇ離したら駄目でしょうがァ～、あっしらみたいな悪い奴らに取られちまうんで」
		PRINTFORML 「今回は授業料ってコトで、ちょっと高めにさせていただいてやすよ」
	ENDIF
	PRINTFORML 「で？　この女にするんで？」
	CALL ASK_MULTI_JUDGE(@"%ANAME(対象)%を買う", MONEY >= SLAVEMARKET_CALC_PRICE(対象), "やめておく", 1)
	IF RESULT == 1
		PRINTFORML 「おや？　そうですか」
		PRINTFORML 「じゃ、誰にするんで？」
		DRAWLINE
		GOTO SHOW_LOOP
	ELSE
		MONEY -= SLAVEMARKET_CALC_PRICE(対象)
		PRINTFORMW 「ひひ、じゃあ商談成立だ」
		PRINTFORMW 「じゃ、持ってってくんなせぇ」
		;確率でエロイベント
		IF IS_FEMALE(対象) && (20 > RAND:100 || 対象 == 特売)
			PRINTFORML
			PRINTFORMW ……男が連れてきた%ANAME(対象)%の姿を見、%ANAME(MASTER)%は目を疑った
			PRINTFORML 丸裸の%ANAME(対象)%は目隠しをされ、手足には枷が嵌められている
			PRINTFORML 剥き出しの胸や臍、秘部には、痛々しいピアスが取り付けられている
			PRINTFORML 全身白濁にまみれており、穴からも粘つく汁がどろどろと零れている
			PRINTFORMW あちこちに書かれた正の字が、%ANAME(対象)%のされたことを物語っていた
			PRINTFORMW そんな悲惨な様だというのに、%ANAME(対象)%はえへらえへらと笑っている
			PRINTFORMW ……これは楽しくて笑っているのではない。何か怪しげな薬の作用だ……
			PRINTFORML
			PRINTFORML 「あ～、市場に並べてる間も、奴隷としてあっしらが使わせていただいてますんでね」
			PRINTFORML 「洗浄はセルフサービスですんで、すいやせんけどね」
			PRINTFORMW 「あっ、返品は受け付けませんよ、残念ですけどねぇ」
			SIF 対象 == 特売
				PRINTFORMW 「ま、特売になるにはそれなりの理由があるってことですよ、へへへ」
			IF IS_LOVER(対象)
				PRINTFORMW 「別に構わんでしょ～？　恋人とカンドーノサイカイができたんだから」
				PRINTFORMW 「これに懲りたら、もっと大事にしてやることですな、げひゃひゃひゃ！」
			ENDIF
			PRINTFORMW 男を斬り捨ててやりたいが、この市場には多くの衛兵がいる。暴れれば自分が危ない
			PRINTFORMW 歯を噛みしめながら、%ANAME(MASTER)%は%ANAME(対象)%を受け取った……
			CALL FORCE_FUCK(対象, -16)
			CFLAG:対象:薬物依存 += RAND(30, 50)
		ELSEIF TALENT:対象:研究用奴隷の烙印
			PRINTFORML 
			PRINTFORMW ……男が連れてきた%ANAME(対象)%の姿は、ひどいものだった
			PRINTFORMW 丸裸の%ANAME(対象)%は全身に様々な"改造"の痕跡がみられた
			PRINTFORMW それだけで、%ANAME(対象)%のされてきたことがうかがえるというものだった
			PRINTFORMW けれども、%ANAME(対象)%が造り替えられたのは、その肉体だけではないらしい
			PRINTFORMW 全身から淫らな香りを漂わす彼女は、こうして%ANAME(MASTER)%に引き渡されたときですら、秘部を弄くり回している
			PRINTFORMW どうやら「研究」とやらは、%ANAME(対象)%の精神をも破壊したようだ
			PRINTFORMW 払い下げられたということだが、なるほど、それもうなずけることだった……
			PRINTFORML
		ELSEIF TALENT:対象:ゴブリンの性奴隷
			PRINTFORML 
			PRINTFORMW ……男が連れてきた%ANAME(対象)%の姿は、ひどいものだった
			PRINTFORMW 丸裸の%ANAME(対象)%の剥き出しの胸や臍、秘部には痛々しいピアスが取り付けられている
			PRINTFORMW さらに頬に目立つように、「性奴隷」という三文字がはっきりと入れ墨で刻まれていた
			PRINTFORMW %ANAME(対象)%は%ANAME(MASTER)%を見るなり、媚びるように擦り寄ってきた
			PRINTFORMW 新しいご主人様、どうか%ANAME(対象)%を可愛がってくださいませと言い始める……
			PRINTFORMW どうやら%ANAME(対象)%は、その精神をも造り替えられてしまったらしい
			PRINTFORMW 性奴隷としての生活がどれほど過酷だったかは、推して知ることのできるものだった……
			PRINTFORML 
		ELSEIF TALENT:対象:野盗の肉便器
			PRINTFORML 
			PRINTFORMW ……男が連れてきた%ANAME(対象)%の姿は、ひどいものだった
			PRINTFORMW 丸裸の%ANAME(対象)%の剥き出しの胸や臍、秘部には痛々しいピアスが取り付けられている
			PRINTFORMW 下腹には目立つように、ハートをモチーフにした焼き印が刻まれていた
			PRINTFORMW 頬と太腿には、「肉便器」という文字がはっきり入れ墨されている……
			PRINTFORMW %ANAME(対象)%は%ANAME(MASTER)%を見るなり、地に手をつけ、深々と頭を下げた
			PRINTFORMW どうか肉便器の%ANAME(対象)%を、気持ちよく使ってくださいませと言い始める……
			PRINTFORMW どうやら%ANAME(対象)%は、その精神をも造り替えられてしまったらしい
			PRINTFORMW 肉便器としての生活がどれほど過酷だったかは、推して知ることのできるものだった……
			PRINTFORML 
		ENDIF
		IF IS_LOVER(対象)
			PRINTFORMW 「ひひ、これに懲りたら、もっと大事にしてやることですな、ひゃひゃひゃ！」
		ELSE
			PRINTFORML 「えっへへへ、毎度ォ」
			PRINTFORMW 「そのオモチャと仲良くやることですな！　げへへへ」
		ENDIF
		PRINTFORMW %ANAME(対象)%を受け取り、市場を後にした……
		IF IS_COUNTRY(CFLAG:対象:所属) && CFLAG:対象:所属 != GET_COUNTRY_FROM_ID(COUNTRY_BANDIT) && CFLAG:対象:所属 != CFLAG:MASTER:所属
			PRINTFORMW ……%ANAME(対象)%は%ANAME(GET_COUNTRY_BOSS(CFLAG:対象:所属))%の所属だ
			PRINTFORMW 返してやるのが人の道であるように思えるが……
			PRINTFORML どうしますか？
			DRAWLINE
			CALL ASK_MULTI("返してやる", "買ったのだから自分のものだ")
			IF RESULT == 0
				PRINTFORMW %ANAME(対象)%を%ANAME(GET_COUNTRY_BOSS(CFLAG:対象:所属))%に返してやることにした
				PRINTFORMW %ANAME(GET_COUNTRY_BOSS(CFLAG:対象:所属))%から深く感謝された……
				CALL CHANGE_RELATION_C_TO_C(CFLAG:対象:所属, CFLAG:MASTER:1, 600, -600)
			ELSE
				PRINTFORMW いやいや、金を出して買ったのだから、もう%ANAME(対象)%は自分のものだ
				PRINTFORMW どのように使ってやろうか考えながら、%ANAME(MASTER)%は市場を後にした……
				CFLAG:対象:所属 = CFLAG:MASTER:所属
			ENDIF
		ELSE
			CFLAG:対象:所属 = CFLAG:MASTER:所属
		ENDIF
		;捕虜状態から解放、部隊から除外、買ったキャラを配列から削除
		CFLAG:対象:捕虜先 = 0
		CALL FORCE_FREE(対象)
		SLAVEMARKET_GOODS:対象添え字 = 0
		
	ENDIF
ENDIF
;-------------------------------------------------
;奴隷市場が利用できるかを返す関数
;-------------------------------------------------
@IS_SLAVEMARKET_AVAILABLE
#FUNCTION

;プレイヤーが野盗所属なら駄目
SIF CFLAG:MASTER:1 == GET_COUNTRY_FROM_ID(COUNTRY_BANDIT)
	RETURNF 0

;商品がいればok
FOR LOCAL, 0, SLAVEMARKET_MAX_GOODS
	SIF ID_TO_CHARA(SLAVEMARKET_GOODS:LOCAL) != -1
		RETURNF 1
NEXT

RETURNF 0

;-------------------------------------------------
;奴隷市場用、奴隷の金額計算関数
;-------------------------------------------------
@SLAVEMARKET_CALC_PRICE(対象)
#FUNCTION
#DIM 対象
#DIM 額
;基礎値に能力とスケベ能力を加算する
額 = 5000
額 += (ABL:対象:武闘 + ABL:対象:知略 + ABL:対象:政治) * 70
額 += (ABL:対象:歌唱 + ABL:対象:料理) * 30
額 += (ABL:対象:欲望 + ABL:対象:性技 + ABL:対象:奉仕 + ABL:対象:性交) * 500

;自国所属と特殊勢力陥落済みは高い
SIF CFLAG:対象:所属 == CFLAG:MASTER:所属
	額 += 5000
SIF TALENT:対象:研究用奴隷の烙印
	額 += 10000
SIF TALENT:対象:ゴブリンの性奴隷
	額 += 10000
SIF TALENT:対象:野盗の肉便器
	額 += 10000

;恋人だと足下見られる
SIF IS_LOVER(対象)
	額 += 20000

;「特売」なら2/3で買える
SIF 対象 == ID_TO_CHARA(SLAVEMARKET_SPECIALGOODS)
	額 = 額 / 3 * 2
RETURNF 額

;-------------------------------------------------
;奴隷市場用、そのターンの商品の準備
;-------------------------------------------------
@SLAVEMARKET_PREPARE_GOODS
#DIM カウンタ
#DIM 候補, 1000
#DIM 候補数
#DIM 野盗
#DIM 外来
#DIM ゴブリン
VARSET 候補, -1
VARSET カウンタ
VARSET SLAVEMARKET_GOODS
VARSET SLAVEMARKET_SPECIALGOODS

野盗 = GET_COUNTRY_FROM_ID(COUNTRY_BANDIT)
外来 = GET_COUNTRY_FROM_ID(COUNTRY_GAIRAI)
ゴブリン = GET_COUNTRY_FROM_ID(COUNTRY_GOBLIN)
;特殊勢力がいなければ抜ける
SIF 野盗 == -1 && 外来 == -1 && ゴブリン == -1
	RETURN 0

;対象を選出
FOR LOCAL, 0, CHARANUM
	;SPキャラは対象としない（野盗そのものがリストアップされるのを防ぐ
	SIF NO:LOCAL >= 2000
		BREAK
	;野盗か外来人かホフゴブリンの捕虜、ないし所属
	IF CFLAG:LOCAL:捕虜先 == 野盗 || (CFLAG:LOCAL:所属 == 野盗 && !CFLAG:LOCAL:捕虜先) || CFLAG:LOCAL:捕虜先 == 外来 || (CFLAG:LOCAL:所属 == 外来 && !CFLAG:LOCAL:捕虜先)|| CFLAG:LOCAL:捕虜先 == ゴブリン || (CFLAG:LOCAL:所属 == ゴブリン && !CFLAG:LOCAL:捕虜先)
		候補:候補数 = LOCAL
		候補数++
	ENDIF
NEXT

;候補がいなければなしで。
IF 候補数 < 1
	RETURN 0
ENDIF

;作成した候補配列からランダムで商品とする。
;この関数をどこで呼び出してもキャラ番号ズレバグが起こらないよう、商品はキャラ番号でなくIDで保存する。
CALL FISHER_YATES_SHAFFLE(候補数)

FOR LOCAL, 0, MIN(候補数, SLAVEMARKET_MAX_GOODS)
	IF RAND:3
		SLAVEMARKET_GOODS:LOCAL = GET_ID(候補:(SHAFFLE_ARRAY:LOCAL))
	ENDIF
NEXT

IF !RAND:3
	SLAVEMARKET_SPECIALGOODS = SLAVEMARKET_GOODS:(RAND:MIN(候補数, SLAVEMARKET_MAX_GOODS))
ELSE
	SLAVEMARKET_SPECIALGOODS = 0
ENDIF
RETURN 1