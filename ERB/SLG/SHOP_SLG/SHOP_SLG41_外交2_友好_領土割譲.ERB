;-------------------------------------------------
;領土を割譲する
;-------------------------------------------------
@DIPLOMACY_GIVE_CITY(ARG:0)
#DIM FIRST_LINE
LOCAL:4 = GET_COUNTRY_BOSS(CFLAG:MASTER:所属)
LOCAL:5 = GET_COUNTRY_BOSS(ARG:0)
CALL TMP_CREATE_UNIT_MAP
CALL TMP_CREATE_RELATION_MAP
;自国の都市の数を数える
LOCAL:6 = 0
FOR LOCAL:0, 0, MAX_CITY
	IF CITY_OWNER:(LOCAL:0) == CFLAG:MASTER:所属 && GET_CITYNAME(LOCAL:0) != "無名" && !IS_STAY_ENEMY_UNIT(LOCAL:0)
		LOCAL:6 ++
	ENDIF
NEXT

IF LOCAL:6 <= 1
	PRINTFORMW 割譲できる領土がありません
	RETURN 0
ENDIF

LOCAL:20 = 1

;1ページに表示する最大キャラ数の設定
LOCAL:7 = 20

;ページ数を計算
LOCAL:8 = (LOCAL:6 - 1) / LOCAL:7 + 1

$SHOW_LOOP1

CALL SINGLE_DRAWLINE
PRINTFORML 割譲する都市を選択して下さい
CALL SINGLE_DRAWLINE
FIRST_LINE = LINECOUNT
$SHOW_LOOP2

LOCAL:10 = LOCAL:7 * (LOCAL:20 - 1)
LOCAL:11 = LOCAL:7 * LOCAL:20
LOCAL:12 = 0
LOCAL:13 = 0

FOR LOCAL:0, 0, MAX_CITY
	IF CITY_OWNER:(LOCAL:0) == CFLAG:MASTER:所属 && GET_CITYNAME(LOCAL:0) != "無名" && !IS_STAY_ENEMY_UNIT(LOCAL:0)
		IF LOCAL:13 >= LOCAL:10 && LOCAL:13 < LOCAL:11
			IF LOCAL:12 % 2 != 0
				PRINTPLAIN   
			ELSE
				IF LOCAL:12 >= 1
					PRINTL 
				ENDIF
				PRINTPLAIN   
			ENDIF
			CALL DRAWCITY_BUTTON(LOCAL:0)
			LOCAL:12 ++
		ENDIF
		LOCAL:13 ++
	ENDIF
NEXT
IF LOCAL:12 >= 1
	PRINTL 
ENDIF

IF LOCAL:8 >= 2
	CALL SINGLE_DRAWLINE
	PRINTPLAIN   
	IF LOCAL:20 >= 2
		PRINTBUTTON "  54[前のページ    ]", 54
	ELSE
		SETCOLOR カラー_選択不可
		PRINTPLAINFORM   54[前のページ    ]
		RESETCOLOR
	ENDIF

	PRINTPLAINFORM         page{LOCAL:20, 2, RIGHT}/{LOCAL:8, 2, LEFT}     
	IF LOCAL:20 < LOCAL:8
		PRINTBUTTON "  56[次のページ    ]", 56
	ELSE
		SETCOLOR カラー_選択不可
		PRINTPLAINFORM   56[次のページ    ]
		RESETCOLOR
	ENDIF
	PRINTL 
ENDIF

CALL SINGLE_DRAWLINE
PRINTPLAIN   
PRINTBUTTON "   0[戻る          ]", 0

REDRAW 0

$INPUT_LOOP
INPUT

IF RESULT == 0
	REDRAW 1
	RETURN 0
ELSEIF RESULT == 54 && LOCAL:20 >= 2
	LOCAL:20 --
	CLEARLINE LINECOUNT - FIRST_LINE
	GOTO SHOW_LOOP2
ELSEIF RESULT == 56 && LOCAL:20 < LOCAL:8
	LOCAL:20 ++
	CLEARLINE LINECOUNT - FIRST_LINE
	GOTO SHOW_LOOP2
ENDIF

LOCAL:15 = (RESULT - 1000)

IF LOCAL:15 >= 0
	REDRAW 1

	;対象キャラの情報を表示
	CALL SINGLE_DRAWLINE
	CALL SHOW_CITY_INFO(LOCAL:15)
	CALL SINGLE_DRAWLINE
	PRINTFORML この領土を割譲しますか？

	;はい／いいえ入力処理
	CALL ASK_YN()
	IF RESULT == 0
		PRINTFORML %GET_CITYNAME(LOCAL:15)%は%NAME:(LOCAL:5)%勢力の領土になりました

		CALL SINGLE_MINIMIZE(LOCAL:15)
		CITY_OWNER:(LOCAL:15) = ARG:0

		;好感度上昇値・敵対値下降値の計算
		;主に能力により決定。相手君主がそのキャラに良い印象を抱いていればボーナス
		LOCAL:25 = 0
		LOCAL:25 += ABL_SQRT(ABL:(LOCAL:15):武闘, -1) + ABL_SQRT(ABL:(LOCAL:15):防衛, -1) + ABL_SQRT(ABL:(LOCAL:15):知略, -1) + ABL_SQRT(ABL:(LOCAL:15):政治, -1)
		LOCAL:25 += ABL_SQRT(ABL:(LOCAL:15):歌唱, -1) + ABL_SQRT(ABL:(LOCAL:15):料理, -1)
		LOCAL:25 /= 400

		LOCAL:25 = LIMIT(LOCAL:25, 25, 400)

		;政治・料理の補正
		CALL TMP_CREATE_IS_FREE_MAP
		LOCAL:0 = SQRT(TMP_GET_POLITICS_POWER(CFLAG:MASTER:所属)) / 10
		LOCAL:1 = SQRT(TMP_GET_COOKING_POWER(CFLAG:MASTER:所属)) / 10
		LOCAL:25 = LOCAL:25 * (LOCAL:0 / 10 + LOCAL:1 / 10) / 100

		;互いの国同士の好感度を上昇させ敵対値を低下させる
		CALL DIPLOMACY_IMPROVE_RELATION(ARG:0, LOCAL:25)
		RETURN 1
	ENDIF
	GOTO SHOW_LOOP1
ENDIF
CLEARLINE 1
GOTO INPUT_LOOP

