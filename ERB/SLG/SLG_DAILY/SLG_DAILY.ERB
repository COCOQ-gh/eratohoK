;複数シナリオにまたがるイベント処理
@SLG_DAILY()
#DIM EVENT_LIST, 100
#DIM EVENT_PICK, 1000
#DIM EVENT_ODDS
#DIM EVENT_COUNT, 2
VARSET LOCAL
VARSET EVENT_PICK

DAILY_CANCEL = 0

;派生イベント関係の処理
CALL SLG_DAILY_DERIVATION

;イベント発生数のセット
EVENT_COUNT:0 = SDCONFIG:951 + 1, SDCONFIG:952 + 1

;イベントリストの作成（起動後作成していなければ）
;イベント追加時は系列に合わせて定数に使用したものを突っ込んでおいてください
IF !EVENT_LIST:1
	VARSET EVENT_LIST, -1
	EVENT_LIST:0 = SDCON_仕官の誘い
ENDIF

;デイリーイベント発生チェック
;例の関数で順番を決めてSELECTCASEにぶん投げる
;順番にイベントフラグ及び発生期間の確認と確率ロールを行い、大丈夫であればイベント本体に移動
;その後、終了フラグが立っていればループを脱出する


;イベント発生倍率のセット
;2^(コンフィグ値-1)+1、つまりDCONFIG:950が0/1/2/3/4の場合1/2/3/5/10倍になる
;なお1000を超えた場合、そのイベントが必ず発生するだけで何ら問題はない（ぉ
EVENT_ODDS = POWER(2, SDCONFIG:SDCON_通常発生頻度 - 1) + 1

;いつもの順番決定、拡張性を考えて枠は100個用意させていただきました
CALL FISHER_YATES_SHAFFLE(100)

;念のため順番を記録
ARRAYCOPY "SHAFFLE_ARRAY" , "EVENT_PICK"

FOR LOCAL:0, 0, 100
	RESULT = -1
	SELECTCASE EVENT_LIST:(EVENT_PICK:(LOCAL:0))
	;士官しないかと誘われる
	;確率判定は本体で行う
	CASE SDCON_仕官の誘い
		SIF !SDCONFIG:SDCON_仕官の誘い
			CALL INVITE_TO_COUNTRY
	;未定義
	CASEELSE
		CONTINUE
	ENDSELECT

	;正常終了していたらカウントを減らす
	;イベントに入る前に弾かれていた場合はカウントしない
	SIF RESULT != -1
		EVENT_COUNT:0 --
	;終了フラグが立っていれば口上デイリー処理へ
	SIF DAILY_CANCEL || !EVENT_COUNT:0
		BREAK

NEXT


