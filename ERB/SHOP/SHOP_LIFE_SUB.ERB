;拠点フェイズにおけるショップ画面の処理
;「婚姻の儀」「触手部屋」などの各メニューの処理を行う

;-------------------------------------------------
;キャラARG:0について、素質<正妻>が<夫>と表示される条件を満たしているかどうか判定
;-------------------------------------------------
@IS_HUSBAND(ARG:0)
#FUNCTION
IF GROUPMATCH(TALENT:MASTER:性別, 1, 2) && GROUPMATCH(TALENT:(ARG:0):性別, 0, 3, 4, 5)
	RETURNF 1
ELSEIF GROUPMATCH(TALENT:MASTER:性別, 4, 5) && GROUPMATCH(TALENT:(ARG:0):性別, 0, 3)
	RETURNF 1
ENDIF
RETURNF 0

;-------------------------------------------------
;婚姻の儀
;-------------------------------------------------
@WEDDING(ARG:0)
IF MONEY < 300000
	PRINTFORMW 所持金が不足しています
	RETURN
ENDIF

IF IS_HUSBAND(ARG:0)
	LOCALS:0 = 夫
ELSE
	LOCALS:0 = 正妻
ENDIF

PRINTFORML %ANAME(ARG:0)%を%LOCALS:0%として迎えます
PRINTL よろしいですか？
CALL ASK_YN
IF RESULT == 1
	RETURN
ENDIF

TALENT:(ARG:0):正妻 = 1
MONEY -= 300000

;口上の表示
CALL KOJO_EVENT(ARG:0, 90)

PRINTL 
CUSTOMDRAWLINE *-
PRINTL 婚姻の儀
CUSTOMDRAWLINE *-
WAIT
PRINTFORMW 式の当日、多くの観衆に祝福されながら、%ANAME(MASTER)%は%ANAME(ARG:0)%を%LOCALS:0%として迎えることを宣言した

;口上の表示
CALL KOJO_EVENT(ARG:0, 91)

PRINTL 
SETCOLOR COLOR("注意")
PRINTFORMW %ANAME(ARG:0)%が%ANAME(MASTER)%の%LOCALS:0%となりました
RESETCOLOR
PRINTL 
PRINTL 

;-------------------------------------------------
;触手部屋の処理
;-------------------------------------------------
@SHOP_SYOKUSYU
#DIM FIRSTLINE
;触手部屋の管理が可能なキャラの数を数える
LOCAL:9 = 0
FOR LOCAL:0, 0, CHARANUM
	IF IS_SYOKUSYU_MANAGE(LOCAL:0)
		LOCAL:9 ++
	ENDIF
NEXT

;ページ数を計算
LOCAL:12 = 30
LOCAL:10 = MAX((LOCAL:9 - 1) / LOCAL:12 + 1, 1)
LOCAL:11 = 1

$SHOW_LOOP1

DRAWLINE
PRINTL 触手部屋
DRAWLINE

PRINTL ●管理者の設定
PRINTL     触手部屋の管理を行うには  <妖術知識>・性知識Lv5以上・主人公以外なら触手Lv5以上  が必要です
PRINTL     触手部屋の管理を行うと、毎ターン若干の妖術経験値と触手経験値を得られます
IF FLAG:35 == -1
	PRINTFORML     現在の管理者はいません
ELSEIF IS_SYOKUSYU_MANAGE(FLAG:35)
	PRINTFORML     現在の管理者は %ANAME(FLAG:35)% です
ELSE
	PRINTFORML     現在の管理者は %ANAME(FLAG:35)% ですが、現在は管理不能です
ENDIF

DRAWLINE
FIRSTLINE = LINECOUNT
$SHOW_LOOP2

;キャラリストの表示
LOCAL:13 = 0
LOCAL:14 = 0
LOCAL:15 = (LOCAL:11 - 1) * LOCAL:12
LOCAL:16 = LOCAL:11 * LOCAL:12
LOCAL:20 = 3
FOR LOCAL:0, 0, CHARANUM
	IF IS_SYOKUSYU_MANAGE(LOCAL:0)
		IF LOCAL:13 >= LOCAL:15 && LOCAL:13 < LOCAL:16
			IF LOCAL:14 % 2 != 0
				PRINT     
			ELSEIF LOCAL:14 >= 1
				PRINTL 
				LOCAL:20 ++
			ENDIF
			PRINT     
			IF LOCAL:0 == FLAG:35
				SETCOLOR COLOR("シアン")
			ENDIF
			PRINTBUTTON @"{NO:(LOCAL:0) + 100, 3}[%ANAME(LOCAL:0), 14, LEFT%]  妖Lv{ABL:(LOCAL:0):妖術, 3, RIGHT}", NO:(LOCAL:0) + 100
			RESETCOLOR
			LOCAL:14 ++
		ENDIF
		LOCAL:13 ++
	ENDIF
NEXT
IF LOCAL:14 >= 1
	PRINTL 
	LOCAL:20 ++
ENDIF

IF LOCAL:10 >= 2
	LOCAL:20 += 2
	DRAWLINE
	PRINT      
	IF LOCAL:11 >= 2
		PRINTBUTTON "54[前のページ    ]", 54
	ELSE
		SETCOLOR COLOR("選択不可")
		PRINTPLAINFORM 54[前のページ    ]
		RESETCOLOR
	ENDIF
	PRINTPLAINFORM %TOSTR_SPACE(10)%
	LOCALS:0 = page{LOCAL:11}/{LOCAL:10}
	PRINTPLAINFORM %LOCALS:0, 14, LEFT%
	IF LOCAL:11 < LOCAL:10
		PRINTBUTTON "56[次のページ    ]", 56
	ELSE
		SETCOLOR COLOR("選択不可")
		PRINTPLAINFORM 56[次のページ    ]
		RESETCOLOR
	ENDIF
	PRINTL 
ENDIF

DRAWLINE
PRINT      
PRINTBUTTON " 0[戻る]", 0

REDRAW 0

$INPUT_LOOP
INPUT

IF RESULT == 0
	REDRAW 1
	RETURN -1
ELSEIF RESULT == 54 && LOCAL:11 >= 2
	LOCAL:11 --
	CLEARLINE LINECOUNT - FIRSTLINE
	GOTO SHOW_LOOP2
ELSEIF RESULT == 56 && LOCAL:11 < LOCAL:10
	LOCAL:11 ++
	CLEARLINE LINECOUNT - FIRSTLINE
	GOTO SHOW_LOOP2
ELSE
	LOCAL:5 = NO_TO_CHARA(RESULT - 100)

	IF LOCAL:5 >= 0 && IS_SYOKUSYU_MANAGE(LOCAL:5)
		REDRAW 1
		IF LOCAL:5 == FLAG:35
			PRINTFORMW %ANAME(LOCAL:5)%を触手部屋の管理者から外しました
			FLAG:35 = -1
		ELSE
			PRINTFORMW %ANAME(LOCAL:5)%を触手部屋の管理者に設定しました
			FLAG:35 = LOCAL:5
		ENDIF
		GOTO SHOW_LOOP1
	ENDIF
ENDIF
CLEARLINE 1
GOTO INPUT_LOOP

;-------------------------------------------------
;キャラARG:0が触手部屋を管理可能であるかどうかを判定する関数
;-------------------------------------------------
@IS_SYOKUSYU_MANAGE(ARG:0)
#FUNCTION
IF CFLAG:(ARG:0):1 == CFLAG:MASTER:1 && CFLAG:(ARG:0):捕虜先 == 0
	IF TALENT:(ARG:0):妖術知識 && ABL:(ARG:0):性知識 >= 5 && (ARG:0 == MASTER || ABL:(ARG:0):触手 >= 5)
		RETURNF 1
	ENDIF
ENDIF
RETURNF 0
