;-------------------------------------------------
;セーブデータのアップデート処理
;-------------------------------------------------
@UPDATE
;シナリオをFLAG:40で持っている場合の処理
IF SCENARIOID == ""
	SCENARIOID '= TOSTR(FLAG:40)
	FLAG:40 = 0
ENDIF

;IF LASTLOAD_VERSION <= 110
;	TALENT:(NAME_TO_CHARA("ミスティア")):髪の長さ=300
;	;菫子追加
;	ADDCHARA 100
;	;初期設定
;	CALL NEWCHARA_INIT(CHARANUM - 1)
;	CFLAG:(NAME_TO_CHARA("菫子")):12 = 1
;	IF ID_TO_CHARA(COUNTRY_BOSS:1) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:1)):99 == "霊夢"
;		COUNTRY_COLOR:1 = 0x757575
;		CFLAG:(NAME_TO_CHARA("菫子")):1 = 1
;		CFLAG:(NAME_TO_CHARA("菫子")):12 = 0
;	ENDIF
;	SIF ID_TO_CHARA(COUNTRY_BOSS:2) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:2)):99 == "レミリア"
;		COUNTRY_COLOR:2 = 0xFF0000
;	SIF ID_TO_CHARA(COUNTRY_BOSS:3) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:3)):99 == "魔理沙"
;		COUNTRY_COLOR:3 = 0xE1D200
;	SIF ID_TO_CHARA(COUNTRY_BOSS:4) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:4)):99 == "幽々子"
;		COUNTRY_COLOR:4 = 0xF5A9F2
;	SIF ID_TO_CHARA(COUNTRY_BOSS:5) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:5)):99 == "紫"
;		COUNTRY_COLOR:5 = 0x792B90
;	SIF ID_TO_CHARA(COUNTRY_BOSS:6) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:6)):99 == "永琳"
;		COUNTRY_COLOR:6 = 0x778CFF
;	SIF ID_TO_CHARA(COUNTRY_BOSS:7) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:7)):99 == "四季映姫"
;		COUNTRY_COLOR:7 = 0x088A08
;	SIF ID_TO_CHARA(COUNTRY_BOSS:8) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:8)):99 == "神奈子"
;		COUNTRY_COLOR:8 = 0x79FF4B
;	SIF ID_TO_CHARA(COUNTRY_BOSS:9) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:9)):99 == "天子"
;		COUNTRY_COLOR:9 = 0x002FFF
;	SIF ID_TO_CHARA(COUNTRY_BOSS:10) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:10)):99 == "さとり"
;		COUNTRY_COLOR:10 = 0xFA5882
;	SIF ID_TO_CHARA(COUNTRY_BOSS:11) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:11)):99 == "白蓮"
;		COUNTRY_COLOR:11 = 0xDF01D7
;	SIF ID_TO_CHARA(COUNTRY_BOSS:12) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:12)):99 == "神子"
;		COUNTRY_COLOR:12 = 0xFF8000
;	SIF ID_TO_CHARA(COUNTRY_BOSS:13) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:13)):99 == "針妙丸"
;		COUNTRY_COLOR:13 = 0x00BFFF
;	SIF ID_TO_CHARA(COUNTRY_BOSS:14) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:14)):99 == "慧音"
;		COUNTRY_COLOR:14 = 0x974E00
;	SIF ID_TO_CHARA(COUNTRY_BOSS:15) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:15)):99 == "依姫"
;		COUNTRY_COLOR:15 = 0xFFF999
;	SIF ID_TO_CHARA(COUNTRY_BOSS:16) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:16)):99 == "チルノ"
;		COUNTRY_COLOR:16 = 0x00FFF7
;	SIF ID_TO_CHARA(COUNTRY_BOSS:17) != -1 && CSTR:(ID_TO_CHARA(COUNTRY_BOSS:17)):99 == "勇儀"
;		COUNTRY_COLOR:17 = 0XFACC2E
;ENDIF
;IF LASTLOAD_VERSION <= 120
;	FOR LOCAL:0, 0, CHARANUM
;		IF TALENT:(LOCAL:0):299
;			TALENT:(LOCAL:0):299 = 0
;			TALENT:(LOCAL:0):研究用奴隷の烙印 = 1
;		ENDIF
;		IF TALENT:(LOCAL:0):342
;			TALENT:(LOCAL:0):342 = 0
;			TALENT:(LOCAL:0):ゴブリンの性奴隷 = 1
;		ENDIF
;	NEXT
;ENDIF
;旧作勢が存在しないので追加
;マップ変更を適用。
IF LASTLOAD_VERSION <= 125
	FOR LOCAL, 0, 200
	IF NO_TO_CHARA(LOCAL) == -1 && EXISTCSV(LOCAL)
			ADDCHARA LOCAL
		CALL NEWCHARA_INIT(CHARANUM -1)
			CFLAG:(CHARANUM -1):12 = 1
		ENDIF
	NEXT
	SETCOLOR COLOR_ALERT
	PRINTFORMW !Ver1.25以前のセーブデータでのプレイを検知しました!
	RESETCOLOR
	PRINTFORMW マップが大幅に変更になりました。現在の周回でのプレイ継続は**不可能**です
	PRINTFORMW 申し訳ありませんが、あらたに周回していただきます
	$UPDATE_LOOP
	CALL GO_NEXT_LOOP
	IF !RESULT
		SETCOLOR COLOR_ALERT
		PRINTFORMW これはアップデート処理ですので、キャンセルはできません!!!!!!!
		PRINTFORMW ごめんな!!!!!!　まだまだ開発中のバリアントだからさ!!!!!!
		RESETCOLOR
	GOTO UPDATE_LOOP
	ENDIF
ENDIF
;旧作キャラ・かんじゅでんキャラ追加、マップのミス修正
IF LASTLOAD_VERSION <= 127
	FOR LOCAL, 0, 200
		IF NO_TO_CHARA(LOCAL) == -1 && EXISTCSV(LOCAL)
			ADDCHARA LOCAL
			CALL NEWCHARA_INIT(CHARANUM -1)
			CFLAG:(CHARANUM -1):12 = 1
		ENDIF
	NEXT
	MAPID = DEFAULT
	CALL MAPSETUP(1)
ENDIF

;素質「下戸」、「キャラ区分」追加
IF LASTLOAD_VERSION <= 129
	FOR LOCAL, 0, 200
		IF EXISTCSV(LOCAL)
			CSVTALENT LOCAL, 136
			TALENT:LOCAL:下戸 = RESULT
			CSVTALENT LOCAL, 350
			TALENT:LOCAL:キャラ区分 = RESULT
		ENDIF
	NEXT
ENDIF

;野盗追加、成長型料理、治療、チルノに超成長力、こいしに人気
IF LASTLOAD_VERSION <= 130
	FOR LOCAL, 0, 200
		IF EXISTCSV(LOCAL)
			CSVTALENT LOCAL, 300
			TALENT:LOCAL:成長型 = RESULT
			CSVTALENT LOCAL, 203
			TALENT:LOCAL:治療 = RESULT
		ENDIF
	NEXT
	SIF NAME_TO_CHARA("チルノ") != -1
		TALENT:(NAME_TO_CHARA("チルノ")):超成長力 = 1
	SIF NAME_TO_CHARA("こいし") != -1
		TALENT:(NAME_TO_CHARA("こいし")):人気 = 1	
	CALL BANDIT_INIT
ENDIF

;戦闘用素質追加、借金取り周りの変更
IF LASTLOAD_VERSION <= 136
	FOR LOCAL, 0, 200
		FOR LOCAL:1, 219, 227
			IF EXISTCSV(LOCAL)
				CSVTALENT LOCAL, LOCAL:1
				TALENT:LOCAL:(LOCAL:1) = RESULT
			ENDIF
		NEXT
	NEXT
	DVAR:4 == DVAR:2
ENDIF