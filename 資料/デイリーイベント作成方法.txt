eratohoK　デイリーイベントを作る
============================

VER0.218以降でのデイリーイベントの制作方法を説明する。なお、口上デイリーについて変化はないのでこの資料では扱わない。
テンプレが`ERB\SYSTEM\EVENT_DAILY\テンプレ`にあるので利用するとよい。

## デイリーイベントのタイプ
大別して以下の二種類になる。

### デイリーイベント
拠点フェイズ終了時に発動する。以下の場合は発動しない。

+ 主人公が捕虜になっており通常の拠点フェイズ終了処理が行われない場合。
+ 放浪していてそもそも拠点フェイズがスキップされる場合。

### SLGデイリー
戦略フェイズ終了時に発動する。主人公が捕虜になっている、統一されている場合は戦略フェイズがスキップされるので発動しない。

## 派生デイリー
「あるデイリーイベントをトリガーとして発動するデイリー」を「派生デイリー」と呼ぶ。通常の派生デイリー、SLG派生デイリーがある。 通常のデイリーやSLGデイリーはコンフィグによる発動個数・発生倍率による縛りを受けるが、派生デイリーはこれを受けない。設定次第で確実に発生させられる。
例えばデイリーイベント「金貸しの来訪」の、「金貸しから金を借りた後の返納イベント」は派生デイリーとして実装されている。「金貸しの来訪」では金を借りた際に「返却までのターン数」が設定される。これは**毎ターン確実に**減少し、0になれば**必ず**返納イベントが発動する必要がある。だからこれらの処理は、発生条件を「金を借りていること」で設定した派生デイリーとして実装されている。
ただし、以上の説明には厳密には正確でない点がある。以下のような状況になると、派生デイリーの発生も確実とはいえなくなる。

+ 捕虜や放浪で、デイリーイベントが発生しない状況になる。
+ 派生元のデイリーをコンフィグでオフにする。

## 事前準備

まず「デイリーイベントの区分」と「デイリーイベントの名前」と「デイリーイベントの関数名」を決める。
区分は先ほど説明した「デイリーイベント」「ＳＬＧデイリー」「派生デイリー」「派生ＳＬＧデイリー」の四つになる。
このうち派生については、元になるデイリーが必須なので、初めて作る場合はデイリーイベントかＳＬＧデイリーになるだろう。
デイリーイベントの名前はそのままで、ゲーム中に表示されるイベント名である。関数名はプログラム上で関数につける名前である。詳細は後述する。
決めたら、ERB\SYSTEM\EVENT_DAILYにCREATE_DAILY_MAP.ERBを開く。区分、デイリーイベントの名前、関数名をREGISTER_DAILYに渡せばよい。

## 関数の種類

各関数を記載したテンプレがテンプレートフォルダに用意されているので、そちらの利用を推奨する。
各関数名に関して、XXは事前準備の項で用意した関数名を意味する。たとえばデイリー「薬売りの来訪」はなら、XXにはSMUGGLERという文字列が入ることになる。
SLG句はSLGデイリーを作る場合に、DERIVATION句は派生デイリーを作る場合に必要になる。この辺りはテンプレに従えば何とかなる。
必須である関数を欠かした場合、デイリーは正常に動作しない。

### 必須であるもの
+ (SLG_)EVENT_DAILY_(DERIVATION_)XX_DECISION
+ (SLG_)EVENT_DAILY_(DERIVATION_)XX　これが本体

### 非派生デイリーに必須
+ (SLG_)EVENT_DAILY_XX_RATE
+ (SLG_)EVENT_DAILY_(DERIVATION_)XX_GENRE

### 派生デイリーに必須
+ (SLG_)EVENT_DAILY_DERIVATION_XX_DISABLE

### 両デイリーにオプショナル
+ (SLG_)EVENT_DAILY_(DERIVATION_)XX_SETTARGET
+ (SLG_)EVENT_DAILY_(DERIVATION_)XX_NAME

## 各関数の説明

### DECISION
全てのデイリーに必須。発生確率以外の発生判定を行う。例えば「特定のフラグが立っている」などである。
非派生デイリーではRATEの後、派生デイリーではDISABLEの後にチェックが行われる。

### RATE
非派生デイリーに必須。発生確率を**千分率で**記述する。
たとえばRETURN 80なら、8%の確率で発生するデイリーになる。

### GENRE
非派生デイリーに必須。デイリーのジャンルを記述する。
どのようなジャンルがあるかは、VARIABLE_DAILY.ERHに記述がある。通常のデイリーとSLGデイリーで異なるので注意。
ジャンルを設定しなくてもデイリー自体は発動するのだが、コンフィグにてオンオフの設定ができなくなる。

### DISABLE
派生デイリーに必須。少しややこしいが、「自身の派生元となるデイリーの、DISABLEフラグを返却する」。
DISABLEフラグが立っている、すなわち派生元デイリーがコンフィグでオフにされている場合、派生デイリーも発生しない。
これは、「派生デイリーは文字通り『派生』してくるものである。派生元がなければ、派生先もないはずである」という考えからくる仕様である。
`RETURN DAILY_DISABLE:(FINDELEMENT(DAILY_EVENT_NAME_ENG, "ANIMAL_SEX_BATTLE"))`のように返却する（これは種族間抗争デイリーの派生）。

### SETTARGET
両デイリーにオプショナル。そのデイリーの対象となるキャラを配列DAILY_TARGETに記録する。
もし対象が一人もいない場合、デイリーを発生させられないので、0を返すこと。
以下に使用例を示す。

``` SETTARGET
FOR LOCAL, 0, CHARANUM
	;捕虜でなく、死んでおらず、精液便女所持者で1/3の確率
	SIF !(!CFLAG:LOCAL:捕虜先 && CFLAG:LOCAL:特殊状態 != 2 && GETBIT(TALENT:LOCAL:淫乱系, 素質_淫乱_精液便女) && RAND:3)
		CONTINUE
	DAILY_TARGET:DAILY_TARGET_NUM = LOCAL
	DAILY_TARGET_NUM ++
NEXT

SIF DAILY_TARGET_NUM < 1
	RETURN 0

RETURN 1
```

``` 本体
FOR LOCAL, 0, DAILY_TARGET_NUM
	対象 = DAILY_TARGET:LOCAL
	CALL EVENT_DAILY_PUBLIC_TOILET_MESSAGE
NEXT
```

### NAME
両デイリーにオプショナル。そのCREATE_DAILY_MAP.ERBで設定したデイリーの名前を無理やり上書きする。
イベントの進行に応じてイベント名を変化させたい……というときに使用する。

### 本体
全てのデイリーに必須。デイリーイベント本体である。
旧バージョンのデイリーと異なり、**DAILY_STARTを呼び出す必要はなくなっている**ことに注意。

## どちらのデイリーにすべきか？
基本的には通常のデイリーを推奨する。以下のような場合にはＳＬＧデイリーを検討するとよいだろう。

+ 主人公が放浪していても発生させたい。
+ 統一後は発生させたくない。